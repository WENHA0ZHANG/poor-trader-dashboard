<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trader Dashboard</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.09);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --border: rgba(255, 255, 255, 0.12);
        --bull: #2ee59d;
        --bear: #ff5d8f;
        --neutral: #8aa2ff;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 10% 10%, rgba(138, 162, 255, 0.25), transparent 50%),
                    radial-gradient(900px 500px at 90% 0%, rgba(46, 229, 157, 0.18), transparent 55%),
                    radial-gradient(900px 500px at 70% 90%, rgba(255, 93, 143, 0.16), transparent 55%),
                    var(--bg);
        color: var(--text);
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 18px 40px; }
      .top {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 16px;
        margin-bottom: 18px;
      }
      h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
      .meta { color: var(--muted); font-size: 12px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
      @media (min-width: 900px) {
        .grid { grid-template-columns: 1fr 1fr; }
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        backdrop-filter: blur(12px);
      }
      .card h2 {
        margin: 0;
        padding: 14px 14px 10px;
        font-size: 14px;
        color: rgba(255,255,255,0.88);
        border-bottom: 1px solid var(--border);
      }
      .market-stack { display: flex; flex-direction: column; gap: 10px; }
      .mini-card h2 { padding: 10px 12px 8px; font-size: 12px; }
      .mini-card th, .mini-card td { padding: 6px 10px; font-size: 11px; }
      .mini-card .empty { padding: 8px 12px; font-size: 11px; }
      .indicator-chart {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
      }
      .indicator-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      .indicator-chart-controls {
        display: inline-flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .indicator-chart-controls button {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.06);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 11px;
        cursor: pointer;
      }
      .indicator-chart-controls button.active {
        background: rgba(138, 162, 255, 0.18);
        border-color: rgba(138, 162, 255, 0.45);
      }
      .indicator-chart-title { font-size: 12px; font-weight: 600; }
      .indicator-chart-canvas { height: 180px; position: relative; }
      .indicator-row { cursor: pointer; }
      .indicator-row.active td { background: rgba(138, 162, 255, 0.14); }
      .stock-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 12px 10px;
        border-bottom: 1px solid var(--border);
      }
      .stock-controls input {
        flex: 1 1 160px;
        min-width: 140px;
        background: rgba(255,255,255,0.06);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 12px;
      }
      .stock-controls button {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.06);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
      }
      .stock-remove-btn {
        border: none;
        background: transparent;
        color: rgba(255,255,255,0.55);
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }
      .stock-remove-btn:hover { color: rgba(255,255,255,0.9); }
      table { width: 100%; border-collapse: collapse; }
      th, td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        font-size: 12px;
        text-align: left;
        vertical-align: middle;
      }
      th { color: rgba(255,255,255,0.75); font-weight: 600; background: rgba(255,255,255,0.03); }
      tr:hover td { background: var(--panel2); }
      code { color: rgba(255,255,255,0.86); background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 8px; }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: 0.3px;
        border: 1px solid rgba(255,255,255,0.15);
        font-size: 12px;
      }
      .pill.bull { color: var(--bull); background: rgba(46, 229, 157, 0.08); border-color: rgba(46, 229, 157, 0.25); }
      .pill.bear { color: var(--bear); background: rgba(255, 93, 143, 0.08); border-color: rgba(255, 93, 143, 0.25); }
      .pill.neutral { color: var(--neutral); background: rgba(138, 162, 255, 0.08); border-color: rgba(138, 162, 255, 0.25); }
      .empty { color: var(--muted); padding: 12px 14px; font-size: 12px; }
      .footer { margin-top: 14px; color: var(--muted); font-size: 12px; }
      .footer a { color: rgba(255,255,255,0.8); text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,0.35); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <h1>Poor Trader Dashboard</h1>
        <div class="meta">
          Last Updated: {{ last_update_time or 'Never Updated' }}
          &nbsp;|&nbsp;
          <a href="/?refresh=1" style="color: white;">Update</a>
        </div>
      </div>

      <div class="grid">
        <div class="card" style="grid-column: span 2;">
          <h2>Bull/Bear Alerts: Top Signals / Bottom Signals (Simplified Rules Based on Historical Thresholds)</h2>
          <div style="display:flex; gap:12px; padding: 12px 14px; flex-wrap: wrap;">
            <div>
              <span class="pill bear">Top Signals</span>
              <span class="meta">Count: <code>{{ top_score }}</code></span>
            </div>
            <div>
              <span class="pill bull">Bottom Signals</span>
              <span class="meta">Count: <code>{{ bottom_score }}</code></span>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 6%; text-align: center;">No.</th>
                <th style="width: 35%">Indicator</th>
                <th style="width: 12%">Top</th>
                <th style="width: 12%">Bottom</th>
                <th style="width: 35%">Rule Description</th>
              </tr>
            </thead>
            <tbody>
              {% for s in signals %}
              <tr>
                <td style="text-align: center;">{{ loop.index }}</td>
                <td>{{ s.title }}</td>
                <td>{% if s.top %}<span class="pill bear">Top</span>{% else %}<span class="pill neutral">—</span>{% endif %}</td>
                <td>{% if s.bottom %}<span class="pill bull">Bottom</span>{% else %}<span class="pill neutral">—</span>{% endif %}</td>
                <td class="meta">{{ s.detail }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="empty">Note: Signals are "early warning/emotional and credit temperature gauges", not trading orders; please combine with position management and risk control.</div>
        </div>

        <div class="card">
          <h2>Indicator Trends & Latest Values</h2>
          <div class="indicator-chart">
            <div class="indicator-chart-header">
              <div>
                <div class="indicator-chart-title" id="indicator-chart-title">Indicator History</div>
                <div class="meta" id="indicator-chart-meta">Click a row below to load history from the database.</div>
              </div>
              <div class="indicator-chart-controls" id="indicator-chart-controls">
                <button data-days="7">1W</button>
                <button data-days="30">1M</button>
                <button data-days="180">6M</button>
                <button data-days="365">1Y</button>
                <button data-days="36500">All</button>
              </div>
            </div>
            <div class="indicator-chart-canvas">
              <canvas id="indicator-chart"></canvas>
            </div>
            <div class="empty" id="indicator-chart-empty">Select an indicator row to view its trend.</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width: 50%">Indicator</th>
                <th style="width: 15%">Date</th>
                <th style="width: 17%">Value</th>
                <th style="width: 18%">Source</th>
              </tr>
            </thead>
            <tbody>
              {% for r in latest_rows %}
              <tr class="indicator-row" data-indicator-id="{{ r.id }}" data-indicator-name="{{ r.name }}" style="{% if r.is_top %}background-color: rgba(255, 93, 143, 0.08); border-left: 3px solid var(--bear);{% elif r.is_bottom %}background-color: rgba(46, 229, 157, 0.08); border-left: 3px solid var(--bull);{% else %}background-color: rgba(255, 255, 255, 0.02); border-left: 3px solid var(--neutral);{% endif %}">
                <td>{{ r.name }}</td>
                <td>{{ r.as_of or "—" }}</td>
                <td style="{% if r.is_top %}color: var(--bear); font-weight: 600;{% elif r.is_bottom %}color: var(--bull); font-weight: 600;{% else %}color: var(--muted);{% endif %}">{{ r.value if r.value is not none else "—" }}</td>
                <td>{% if r.source_url %}<a href="{{ r.source_url }}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none;">{{ r.source or "—" }}</a>{% else %}{{ r.source or "—" }}{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="market-stack">
          <div class="card mini-card">
            <h2>US Market Indices <a href="#" onclick="loadMarketOverview(); return false;" style="color: rgba(255,255,255,0.8); font-weight: 500;">Update</a></h2>
            <table>
              <thead>
                <tr>
                  <th style="width: 18%">Name</th>
                  <th style="width: 18%">Date</th>
                  <th style="width: 18%">Latest</th>
                  <th style="width: 11.5%">1W</th>
                  <th style="width: 11.5%">1M</th>
                  <th style="width: 11.5%">3M</th>
                  <th style="width: 11.5%">1Y</th>
                </tr>
              </thead>
              <tbody id="market-body-indices">
                {% if (market_rows is none) or (market_rows|length == 0) %}
                <tr id="market-loading-row-indices">
                  <td colspan="7" class="meta">Loading... (this section loads asynchronously after page load)</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="card mini-card">
            <h2>Futures & Crypto <a href="#" onclick="loadMarketOverview(); return false;" style="color: rgba(255,255,255,0.8); font-weight: 500;">Update</a></h2>
            <table>
              <thead>
                <tr>
                  <th style="width: 18%">Name</th>
                  <th style="width: 18%">Date</th>
                  <th style="width: 18%">Latest</th>
                  <th style="width: 11.5%">1W</th>
                  <th style="width: 11.5%">1M</th>
                  <th style="width: 11.5%">3M</th>
                  <th style="width: 11.5%">1Y</th>
                </tr>
              </thead>
              <tbody id="market-body-assets">
                {% if (market_rows is none) or (market_rows|length == 0) %}
                <tr id="market-loading-row-assets">
                  <td colspan="7" class="meta">Loading... (this section loads asynchronously after page load)</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="card mini-card">
            <h2>Stocks <a href="#" onclick="loadMarketOverview(); return false;" style="color: rgba(255,255,255,0.8); font-weight: 500;">Update</a></h2>
            <div class="stock-controls">
              <input id="stock-search-input" type="text" placeholder="Search/add ticker (e.g., AAPL)" />
              <button id="stock-add-btn" type="button">Add</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th style="width: 18%">Name</th>
                  <th style="width: 18%">Date</th>
                  <th style="width: 18%">Latest</th>
                  <th style="width: 11.5%">1W</th>
                  <th style="width: 11.5%">1M</th>
                  <th style="width: 11.5%">3M</th>
                  <th style="width: 11.5%">1Y</th>
                  <th style="width: 4%"></th>
                </tr>
              </thead>
              <tbody id="market-body-stocks">
                {% if (market_rows is none) or (market_rows|length == 0) %}
                <tr id="market-loading-row-stocks">
                  <td colspan="8" class="meta">Loading... (this section loads asynchronously after page load)</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div class="card" style="margin-top: 14px;">
        <h2>History: Major Top/Bottom Comparisons After 2000 (Based on ^SPX Drawdown >= 15%)</h2>
        <table>
          <thead>
            <tr>
              <th style="width: 16%">Event</th>
              <th style="width: 12%; text-align: center;">Peak Date</th>
              <th style="width: 12%; text-align: center;">Trough Date</th>
              <th style="width: 8%; text-align: center;">Drawdown</th>
              <th style="width: 13%; text-align: center;">High Yield(P/T)</th>
              <th style="width: 13%; text-align: center;">Bull-Bear(P/T)</th>
              <th style="width: 13%; text-align: center;">Fear & Greed(P/T)</th>
              <th style="width: 13%; text-align: center;">S&P500 PE(P/T)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in bear_rows %}
            <tr>
              <td>{{ r.event_name }}</td>
              <td style="text-align: center;">{{ r.peak_date }}</td>
              <td style="text-align: center;">{{ r.trough_date }}</td>
              <td style="color: var(--bear); font-weight: bold; text-align: center;">{{ r.drawdown_pct }}%</td>
              <td style="text-align: center;">{{ (r.peak_hy ~ "%") if r.peak_hy else "—" }} / {{ (r.trough_hy ~ "%") if r.trough_hy else "—" }}</td>
              <td style="text-align: center;">{{ (r.peak_aaii ~ "%") if r.peak_aaii else "—" }} / {{ (r.trough_aaii ~ "%") if r.trough_aaii else "—" }}</td>
              <td style="text-align: center;">{{ r.peak_cnn if r.peak_cnn else "—" }} / {{ r.trough_cnn if r.trough_cnn else "—" }}</td>
              <td style="text-align: center;">{{ (r.peak_pe ~ "x") if r.peak_pe else "—" }} / {{ (r.trough_pe ~ "x") if r.trough_pe else "—" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="empty">Note: Historical comparison table is a hardcoded snapshot (for comparison and rule backtesting), data compiled from Federal Reserve FRED (HY Spread), AAII (Sentiment), CNN (Fear & Greed), Multpl (SP500 PE). CNN data not available before 2012.</div>
      </div>

      <div class="footer">
        {% if fetch_ok and fetch_ok|length > 0 %}
          <div style="margin-bottom:8px; color: rgba(46, 229, 157, 0.85);">
            Fetch Success: {{ fetch_ok | join("; ") }}
          </div>
        {% endif %}
        {% if fetch_err and fetch_err|length > 0 %}
          <div style="margin-bottom:8px; color: rgba(255, 93, 143, 0.9);">
            Fetch Failed: {{ fetch_err | join("; ") }}
          </div>
        {% endif %}

        Note: Run <code>trader ingest</code> or <code>trader fetch</code> to write data first, then refresh the page.
        API: <a href="/api/latest">/api/latest</a> / <a href="/api/alerts">/api/alerts</a>
        <div style="margin-top:6px;">
          Auto Fetch: <code>{{ "On" if auto_fetch_enabled else "Off" }}</code>
          <button onclick="toggleAutoFetch()" style="margin-left:10px; padding:2px 8px; font-size:11px;">
            {{ "Turn Off" if auto_fetch_enabled else "Turn On" }}
          </button>     Providers: <code>{{ auto_fetch_providers | join(",") }}</code>;
          Cooldown: <code>{{ cooldown_seconds }}s</code>
        </div>

        <script>
        function toggleAutoFetch() {
            fetch('/api/toggle-autofetch', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Refresh page to show new state
                    } else {
                        alert('Failed to toggle auto-fetch: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script>
        let indicatorChart = null;
        let currentIndicatorId = null;
        let currentIndicatorName = null;
        let currentRangeDays = 365;

        function _formatChartValue(value, unit) {
          if (value === null || value === undefined) return "—";
          const n = Number(value);
          if (Number.isNaN(n)) return "—";
          const formatted = n.toFixed(2);
          if (!unit) return formatted;
          return unit === "%" ? `${formatted}%` : `${formatted} ${unit}`;
        }

        function _parseDateLabel(label) {
          if (!label) return null;
          const parts = String(label).split("-");
          if (parts.length < 3) return null;
          return { y: parts[0], m: parts[1], d: parts[2] };
        }

        function _formatDateLabel(label, prevLabel) {
          const curr = _parseDateLabel(label);
          if (!curr) return label || "";
          const prev = _parseDateLabel(prevLabel);
          const showYear = !prev || prev.y !== curr.y;
          return showYear ? `${curr.y}-${curr.m}-${curr.d}` : `${curr.m}-${curr.d}`;
        }

        function _getTickIndexes(total) {
          if (total <= 5) {
            return new Set(Array.from({ length: total }, (_, i) => i));
          }
          const idx = new Set();
          for (let i = 0; i < 5; i += 1) {
            idx.add(Math.round(i * (total - 1) / 4));
          }
          return idx;
        }

        const thresholdLabelPlugin = {
          id: "thresholdLabels",
          afterDatasetsDraw(chart, args, opts) {
            const { ctx, chartArea, scales } = chart;
            if (!chartArea || !scales || !scales.y) return;
            const yScale = scales.y;
            const xRight = chartArea.right - 6;
            const boxes = [];

            ctx.save();
            ctx.font = "11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
            ctx.textBaseline = "middle";

            function _boxForText(x, y, text, align) {
              const w = ctx.measureText(text).width;
              const h = 12;
              const x1 = align === "right" ? x - w : x;
              return { x1, y1: y - h / 2, x2: x1 + w, y2: y + h / 2 };
            }

            function _intersects(a, b) {
              return !(a.x2 < b.x1 || a.x1 > b.x2 || a.y2 < b.y1 || a.y1 > b.y2);
            }

            function _fits(box) {
              return box.y1 >= chartArea.top && box.y2 <= chartArea.bottom;
            }

            function _placeLabel(text, yValue, color, alignRight = true) {
              const yLine = yScale.getPixelForValue(yValue);
              if (yLine < chartArea.top || yLine > chartArea.bottom) return;
              const x = xRight;
              const align = alignRight ? "right" : "left";
              const aboveY = yLine - 10;
              const belowY = yLine + 10;

              let y = aboveY;
              let box = _boxForText(x, y, text, align);
              if (!_fits(box)) {
                y = belowY;
                box = _boxForText(x, y, text, align);
              }

              for (const b of boxes) {
                if (_intersects(box, b)) {
                  const altY = y === aboveY ? belowY : aboveY;
                  const altBox = _boxForText(x, altY, text, align);
                  if (_fits(altBox) && !_intersects(altBox, b)) {
                    y = altY;
                    box = altBox;
                  } else {
                    const shiftedY = altY + 12;
                    const shiftedBox = _boxForText(x, shiftedY, text, align);
                    if (_fits(shiftedBox) && !_intersects(shiftedBox, b)) {
                      y = shiftedY;
                      box = shiftedBox;
                    }
                  }
                }
              }

              ctx.fillStyle = color;
              ctx.textAlign = align;
              ctx.fillText(text, x, y);
              boxes.push(box);
            }

            if (opts && opts.top !== null && opts.top !== undefined && !Number.isNaN(opts.top)) {
              _placeLabel(
                `Top ${_formatChartValue(opts.top, opts.unit)}`,
                opts.top,
                "rgba(255, 93, 143, 0.95)"
              );
            }

            if (opts && opts.bottom !== null && opts.bottom !== undefined && !Number.isNaN(opts.bottom)) {
              _placeLabel(
                `Bottom ${_formatChartValue(opts.bottom, opts.unit)}`,
                opts.bottom,
                "rgba(46, 229, 157, 0.95)"
              );
            }

            const meta = chart.getDatasetMeta(0);
            if (meta && meta.data && meta.data.length) {
              const lastPoint = meta.data[meta.data.length - 1];
              if (lastPoint && opts && opts.latest !== null && opts.latest !== undefined && !Number.isNaN(opts.latest)) {
                let x = lastPoint.x + 6;
                let y = lastPoint.y;
                let align = "left";
                if (x > chartArea.right - 70) {
                  x = lastPoint.x - 6;
                  align = "right";
                }
                let text = `Latest ${_formatChartValue(opts.latest, opts.unit)}`;
                let box = _boxForText(x, y, text, align);
                if (!_fits(box)) {
                  y = lastPoint.y - 10;
                  box = _boxForText(x, y, text, align);
                }
                for (const b of boxes) {
                  if (_intersects(box, b)) {
                    const altY = y + 12;
                    const altBox = _boxForText(x, altY, text, align);
                    if (_fits(altBox) && !_intersects(altBox, b)) {
                      y = altY;
                      box = altBox;
                    } else {
                      const altY2 = y - 12;
                      const altBox2 = _boxForText(x, altY2, text, align);
                      if (_fits(altBox2) && !_intersects(altBox2, b)) {
                        y = altY2;
                        box = altBox2;
                      }
                    }
                  }
                }
                ctx.fillStyle = "rgba(138, 162, 255, 0.95)";
                ctx.textAlign = align;
                ctx.fillText(text, x, y);
              }
            }

            ctx.restore();
          },
        };

        function _fmtPct(v) {
          if (v === null || v === undefined) return "—";
          const n = Number(v);
          if (Number.isNaN(n)) return "—";
          return n.toFixed(2) + "%";
        }
        function _pctStyle(v) {
          if (v === null || v === undefined) return "";
          const n = Number(v);
          if (Number.isNaN(n)) return "";
          return (n >= 0 ? "color: var(--bull);" : "color: var(--bear);") + "font-weight: 600;";
        }
        function _renderMarketTable(tbody, rows, opts = {}) {
          if (!tbody) return;
          const loading = tbody.querySelector("tr[id^='market-loading-row']");
          if (loading) loading.remove();
          tbody.innerHTML = "";
          if (!rows || rows.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = opts.withDelete ? 8 : 7;
            td.className = "meta";
            td.textContent = "No data (stooq may be unstable; please try again later or refresh the page)";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }
          for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.name ?? "—"}</td>
              <td>${r.as_of ?? "—"}</td>
              <td style="font-weight:700;">${(r.close !== null && r.close !== undefined) ? Number(r.close).toFixed(2) : "—"}</td>
              <td style="${_pctStyle(r.chg_1w_pct)}">${_fmtPct(r.chg_1w_pct)}</td>
              <td style="${_pctStyle(r.chg_1m_pct)}">${_fmtPct(r.chg_1m_pct)}</td>
              <td style="${_pctStyle(r.chg_3m_pct)}">${_fmtPct(r.chg_3m_pct)}</td>
              <td style="${_pctStyle(r.chg_1y_pct)}">${_fmtPct(r.chg_1y_pct)}</td>
            `;
            if (opts.withDelete) {
              const td = document.createElement("td");
              td.style.textAlign = "right";
              const btn = document.createElement("button");
              btn.className = "stock-remove-btn";
              btn.type = "button";
              btn.textContent = "×";
              btn.addEventListener("click", () => {
                const sym = normalizeTicker(r.symbol || r.name || "");
                if (!sym) return;
                const custom = new Set(getCustomStocks());
                if (custom.has(sym)) {
                  custom.delete(sym);
                  saveCustomStocks(Array.from(custom));
                } else {
                  const hidden = new Set(getHiddenStocks());
                  hidden.add(sym);
                  saveHiddenStocks(Array.from(hidden));
                }
                loadMarketOverview();
              });
              td.appendChild(btn);
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
        }

        function renderMarketRows(rows) {
          const tbodyIndices = document.getElementById("market-body-indices");
          const tbodyAssets = document.getElementById("market-body-assets");
          const tbodyStocks = document.getElementById("market-body-stocks");
          if (!tbodyIndices || !tbodyAssets || !tbodyStocks) return;

          const rowMap = new Map();
          for (const r of rows || []) {
            const key = String(r.symbol || "").toLowerCase();
            if (key) rowMap.set(key, r);
          }

          const indexList = [
            { symbol: "^spx", name: "^SPX" },
            { symbol: "^dji", name: "^DJI" },
            { symbol: "^ndq", name: "^NDQ" },
          ];
          const assetList = [
            { symbol: "btc.v", name: "BTC" },
            { symbol: "xauusd", name: "XAU" },
            { symbol: "xagusd", name: "XAG" },
          ];

          const defaultStocks = ["BRK-B", "KO", "RKLB", "AMZN"];
          const customStocks = getCustomStocks();
          const hidden = new Set(getHiddenStocks().map(s => s.toLowerCase()));
          const stockList = [];
          for (const t of [...defaultStocks, ...customStocks]) {
            const norm = normalizeTicker(t);
            if (!norm) continue;
            if (hidden.has(norm.toLowerCase())) continue;
            stockList.push({ symbol: `${norm.toLowerCase()}.us`, name: norm });
          }

          const indices = indexList.map(it => rowMap.get(it.symbol) || { name: it.name, symbol: it.symbol });
          const assets = assetList.map(it => rowMap.get(it.symbol) || { name: it.name, symbol: it.symbol });
          const stocks = stockList.map(it => rowMap.get(it.symbol) || { name: it.name, symbol: it.symbol });

          _renderMarketTable(tbodyIndices, indices);
          _renderMarketTable(tbodyAssets, assets);
          _renderMarketTable(tbodyStocks, stocks, { withDelete: true });
        }
        const STOCK_STORAGE_KEY = "market.customStocks";
        const STOCK_HIDDEN_KEY = "market.hiddenStocks";
        const MARKET_CACHE_KEY = "market.overview.cache";

        function getCustomStocks() {
          try {
            const raw = localStorage.getItem(STOCK_STORAGE_KEY);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
          } catch (e) {
            return [];
          }
        }

        function saveCustomStocks(list) {
          localStorage.setItem(STOCK_STORAGE_KEY, JSON.stringify(list));
        }

        function getHiddenStocks() {
          try {
            const raw = localStorage.getItem(STOCK_HIDDEN_KEY);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
          } catch (e) {
            return [];
          }
        }

        function saveHiddenStocks(list) {
          localStorage.setItem(STOCK_HIDDEN_KEY, JSON.stringify(list));
        }

        function saveMarketCache(rows) {
          try {
            localStorage.setItem(
              MARKET_CACHE_KEY,
              JSON.stringify({ rows: rows || [], savedAt: new Date().toISOString() })
            );
          } catch (e) {
            // ignore storage errors
          }
        }

        function getMarketCache() {
          try {
            const raw = localStorage.getItem(MARKET_CACHE_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (!parsed || !Array.isArray(parsed.rows)) return null;
            return parsed.rows;
          } catch (e) {
            return null;
          }
        }

        function normalizeTicker(raw) {
          let s = String(raw || "").trim().toUpperCase().replace(/\s+/g, "");
          if (!s) return null;
          if (s.endsWith(".US")) s = s.slice(0, -3);
          s = s.replace(/\./g, "-");
          if (!/^[A-Z0-9-]+$/.test(s)) return null;
          return s;
        }

        function initStockSearch() {
          const input = document.getElementById("stock-search-input");
          const btn = document.getElementById("stock-add-btn");
          if (!input || !btn) return;
          const add = () => {
            const norm = normalizeTicker(input.value);
            if (!norm) return;
            const current = new Set(getCustomStocks());
            current.add(norm);
            saveCustomStocks(Array.from(current).sort());
            const hidden = new Set(getHiddenStocks());
            hidden.delete(norm);
            saveHiddenStocks(Array.from(hidden));
            input.value = "";
            loadMarketOverview();
          };
          btn.addEventListener("click", add);
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              add();
            }
          });
        }

        async function loadMarketOverview() {
          try {
            const extra = getCustomStocks();
            const query = extra.length ? `?symbols=${encodeURIComponent(extra.join(","))}` : "";
            const resp = await fetch(`/api/market-overview${query}`);
            if (!resp.ok) return;
            const data = await resp.json();
            const rows = data.rows || [];
            if (rows.length > 0) {
              saveMarketCache(rows);
              renderMarketRows(rows);
            } else {
              const cached = getMarketCache();
              renderMarketRows(cached || []);
            }
          } catch (e) {
            const cached = getMarketCache();
            renderMarketRows(cached || []);
          }
        }
        async function loadIndicatorHistory(indicatorId, indicatorName, days) {
          const titleEl = document.getElementById("indicator-chart-title");
          const metaEl = document.getElementById("indicator-chart-meta");
          const emptyEl = document.getElementById("indicator-chart-empty");
          const canvas = document.getElementById("indicator-chart");
          if (!titleEl || !metaEl || !emptyEl || !canvas) return;

          titleEl.textContent = indicatorName || indicatorId;
          metaEl.textContent = "Loading...";
          emptyEl.style.display = "none";

          if (typeof Chart === "undefined") {
            metaEl.textContent = "Chart library unavailable.";
            emptyEl.style.display = "block";
            return;
          }

          try {
            const resp = await fetch(`/api/indicator-history?indicator_id=${encodeURIComponent(indicatorId)}&days=${days}`);
            if (!resp.ok) {
              metaEl.textContent = "Failed to load history.";
              emptyEl.style.display = "block";
              return;
            }
            const data = await resp.json();
            const series = data.series || [];
            const unit = data.unit || "";
            const topLineValue = (data.top === null || data.top === undefined) ? null : Number(data.top);
            const bottomLineValue = (data.bottom === null || data.bottom === undefined) ? null : Number(data.bottom);
            if (!series.length) {
              metaEl.textContent = "No history available.";
              emptyEl.style.display = "block";
              if (indicatorChart) {
                indicatorChart.destroy();
                indicatorChart = null;
              }
              return;
            }

            const labels = series.map(p => p.date);
            const values = series.map(p => p.value);
            const latestValue = values[values.length - 1];

            const datasets = [{
              label: unit ? `${indicatorName} (${unit})` : indicatorName,
              data: values,
              borderColor: "rgba(138, 162, 255, 0.9)",
              backgroundColor: "rgba(138, 162, 255, 0.15)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              fill: "start",
            }];

            if (!Number.isNaN(topLineValue) && topLineValue !== null) {
              datasets.push({
                label: "Top",
                data: labels.map(() => topLineValue),
                borderColor: "rgba(255, 93, 143, 0.9)",
                borderDash: [6, 6],
                borderWidth: 1,
                pointRadius: 0,
                fill: false,
              });
            }

            if (!Number.isNaN(bottomLineValue) && bottomLineValue !== null) {
              datasets.push({
                label: "Bottom",
                data: labels.map(() => bottomLineValue),
                borderColor: "rgba(46, 229, 157, 0.9)",
                borderDash: [6, 6],
                borderWidth: 1,
                pointRadius: 0,
                fill: false,
              });
            }

            if (indicatorChart) {
              indicatorChart.destroy();
            }

            indicatorChart = new Chart(canvas, {
              type: "line",
              plugins: [thresholdLabelPlugin],
              data: {
                labels,
                datasets,
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  thresholdLabels: {
                    top: topLineValue,
                    bottom: bottomLineValue,
                    latest: latestValue,
                    unit,
                  },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => _formatChartValue(ctx.parsed.y, unit),
                    },
                  },
                },
                scales: {
                  x: {
                    ticks: {
                      color: "rgba(255,255,255,0.65)",
                      autoSkip: false,
                      maxRotation: 0,
                      minRotation: 0,
                      callback: function(value, index, ticks) {
                        const shown = _getTickIndexes(ticks.length);
                        if (!shown.has(index)) return "";
                        const label = this.getLabelForValue(value);
                        let prevLabel = null;
                        for (let i = index - 1; i >= 0; i -= 1) {
                          if (shown.has(i)) {
                            prevLabel = this.getLabelForValue(ticks[i].value);
                            break;
                          }
                        }
                        return _formatDateLabel(label, prevLabel);
                      },
                    },
                    grid: {
                      color: (ctx) => {
                        const total = ctx.scale.ticks.length;
                        const shown = _getTickIndexes(total);
                        return shown.has(ctx.index) ? "rgba(255,255,255,0.06)" : "rgba(255,255,255,0)";
                      },
                    },
                  },
                  y: {
                    ticks: { color: "rgba(255,255,255,0.65)", maxTicksLimit: 5, count: 5 },
                    grid: { color: "rgba(255,255,255,0.06)" },
                  },
                },
              },
            });

            const topText = (!Number.isNaN(topLineValue) && topLineValue !== null)
              ? `Top: ${_formatChartValue(topLineValue, unit)}`
              : null;
            const bottomText = (!Number.isNaN(bottomLineValue) && bottomLineValue !== null)
              ? `Bottom: ${_formatChartValue(bottomLineValue, unit)}`
              : null;
            const thresholdText = [topText, bottomText].filter(Boolean).join(" | ");
            const rangeText = days >= 36500 ? "All" : `${days}D`;
            metaEl.textContent = thresholdText
              ? `${series.length} points · ${rangeText} · ${thresholdText}`
              : `${series.length} points · ${rangeText}`;
            emptyEl.style.display = "none";
          } catch (e) {
            metaEl.textContent = "Failed to load history.";
            emptyEl.style.display = "block";
          }
        }

        function setRange(days) {
          currentRangeDays = days;
          const controls = document.getElementById("indicator-chart-controls");
          if (controls) {
            controls.querySelectorAll("button").forEach(btn => {
              btn.classList.toggle("active", Number(btn.dataset.days) === days);
            });
          }
          if (currentIndicatorId) {
            loadIndicatorHistory(currentIndicatorId, currentIndicatorName, currentRangeDays);
          }
        }

        function initIndicatorRanges() {
          const controls = document.getElementById("indicator-chart-controls");
          if (!controls) return;
          controls.querySelectorAll("button").forEach(btn => {
            btn.addEventListener("click", () => {
              const days = Number(btn.dataset.days);
              if (!Number.isNaN(days)) {
                setRange(days);
              }
            });
          });
          setRange(currentRangeDays);
        }

        function initIndicatorChart() {
          const rows = Array.from(document.querySelectorAll(".indicator-row"));
          if (!rows.length) return;
          rows.forEach(row => {
            row.addEventListener("click", () => {
              rows.forEach(r => r.classList.remove("active"));
              row.classList.add("active");
              const id = row.getAttribute("data-indicator-id");
              const name = row.getAttribute("data-indicator-name");
              if (id) {
                currentIndicatorId = id;
                currentIndicatorName = name || id;
                loadIndicatorHistory(currentIndicatorId, currentIndicatorName, currentRangeDays);
              }
            });
          });
          rows[0].click();
        }

        window.addEventListener("load", () => {
          loadMarketOverview();
          initStockSearch();
          initIndicatorRanges();
          initIndicatorChart();
        });
        </script>
        <div style="margin-top:6px;">
          Indicator Sources:
          {% for s in sources %}
            <a href="{{ s.url }}" target="_blank" rel="noopener">{{ s.name }}</a>{% if not loop.last %} / {% endif %}
          {% endfor %}
        </div>
        <div style="margin-top:8px;">
          For collaboration or questions, please reach out via the project GitHub:
          <a href="https://github.com/WENHA0ZHANG/poor-trader-dashboard" target="_blank" rel="noopener">
            https://github.com/WENHA0ZHANG/poor-trader-dashboard
          </a>
          · Personal site:
          <a href="https://wenha0zhang.github.io/" target="_blank" rel="noopener">
            https://wenha0zhang.github.io/
          </a>
        </div>
      </div>
    </div>
  </body>
</html>

