<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trader Dashboard</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.09);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --border: rgba(255, 255, 255, 0.12);
        --bull: #2ee59d;
        --bear: #ff5d8f;
        --neutral: #8aa2ff;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 10% 10%, rgba(138, 162, 255, 0.25), transparent 50%),
                    radial-gradient(900px 500px at 90% 0%, rgba(46, 229, 157, 0.18), transparent 55%),
                    radial-gradient(900px 500px at 70% 90%, rgba(255, 93, 143, 0.16), transparent 55%),
                    var(--bg);
        color: var(--text);
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 18px 40px; }
      .top {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 16px;
        margin-bottom: 18px;
      }
      h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
      .meta { color: var(--muted); font-size: 12px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
      @media (min-width: 900px) {
        .grid { grid-template-columns: 1fr 1fr; }
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        backdrop-filter: blur(12px);
      }
      .card h2 {
        margin: 0;
        padding: 14px 14px 10px;
        font-size: 14px;
        color: rgba(255,255,255,0.88);
        border-bottom: 1px solid var(--border);
      }
      table { width: 100%; border-collapse: collapse; }
      th, td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        font-size: 12px;
        text-align: left;
        vertical-align: middle;
      }
      th { color: rgba(255,255,255,0.75); font-weight: 600; background: rgba(255,255,255,0.03); }
      tr:hover td { background: var(--panel2); }
      code { color: rgba(255,255,255,0.86); background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 8px; }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: 0.3px;
        border: 1px solid rgba(255,255,255,0.15);
        font-size: 12px;
      }
      .pill.bull { color: var(--bull); background: rgba(46, 229, 157, 0.08); border-color: rgba(46, 229, 157, 0.25); }
      .pill.bear { color: var(--bear); background: rgba(255, 93, 143, 0.08); border-color: rgba(255, 93, 143, 0.25); }
      .pill.neutral { color: var(--neutral); background: rgba(138, 162, 255, 0.08); border-color: rgba(138, 162, 255, 0.25); }
      .empty { color: var(--muted); padding: 12px 14px; font-size: 12px; }
      .footer { margin-top: 14px; color: var(--muted); font-size: 12px; }
      .footer a { color: rgba(255,255,255,0.8); text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,0.35); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <h1>Poor Trader Dashboard</h1>
        <div class="meta">
          Last Updated: {{ last_update_time or 'Never Updated' }}
          &nbsp;|&nbsp;
          <a href="/?refresh=1" style="color: white;">Update</a>
        </div>
      </div>

      <div class="grid">
        <div class="card" style="grid-column: span 2;">
          <h2>Bull/Bear Alerts: Top Signals / Bottom Signals (Simplified Rules Based on Historical Thresholds)</h2>
          <div style="display:flex; gap:12px; padding: 12px 14px; flex-wrap: wrap;">
            <div>
              <span class="pill bear">Top Signals</span>
              <span class="meta">Count: <code>{{ top_score }}</code></span>
            </div>
            <div>
              <span class="pill bull">Bottom Signals</span>
              <span class="meta">Count: <code>{{ bottom_score }}</code></span>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 6%; text-align: center;">No.</th>
                <th style="width: 35%">Indicator</th>
                <th style="width: 12%">Top</th>
                <th style="width: 12%">Bottom</th>
                <th style="width: 35%">Rule Description</th>
              </tr>
            </thead>
            <tbody>
              {% for s in signals %}
              <tr>
                <td style="text-align: center;">{{ loop.index }}</td>
                <td>{{ s.title }}</td>
                <td>{% if s.top %}<span class="pill bear">Top</span>{% else %}<span class="pill neutral">—</span>{% endif %}</td>
                <td>{% if s.bottom %}<span class="pill bull">Bottom</span>{% else %}<span class="pill neutral">—</span>{% endif %}</td>
                <td class="meta">{{ s.detail }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="empty">Note: Signals are "early warning/emotional and credit temperature gauges", not trading orders; please combine with position management and risk control.</div>
        </div>

        <div class="card">
          <h2>Latest Indicator Values</h2>
          <table>
            <thead>
              <tr>
                <th style="width: 50%">Indicator</th>
                <th style="width: 15%">Date</th>
                <th style="width: 17%">Value</th>
                <th style="width: 18%">Source</th>
              </tr>
            </thead>
            <tbody>
              {% for r in latest_rows %}
              <tr style="{% if r.is_top %}background-color: rgba(255, 93, 143, 0.08); border-left: 3px solid var(--bear);{% elif r.is_bottom %}background-color: rgba(46, 229, 157, 0.08); border-left: 3px solid var(--bull);{% else %}background-color: rgba(255, 255, 255, 0.02); border-left: 3px solid var(--neutral);{% endif %}">
                <td>{{ r.name }}</td>
                <td>{{ r.as_of or "—" }}</td>
                <td style="{% if r.is_top %}color: var(--bear); font-weight: 600;{% elif r.is_bottom %}color: var(--bull); font-weight: 600;{% else %}color: var(--muted);{% endif %}">{{ r.value if r.value is not none else "—" }}</td>
                <td>{% if r.source_url %}<a href="{{ r.source_url }}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none;">{{ r.source or "—" }}</a>{% else %}{{ r.source or "—" }}{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>US Market Overview (Real-time): Major Indices & Key Stocks</h2>
          <table>
            <thead>
              <tr>
                <th style="width: 18%">Name</th>
                <th style="width: 18%">Date</th>
                <th style="width: 18%">Latest</th>
                <th style="width: 11.5%">1W</th>
                <th style="width: 11.5%">1M</th>
                <th style="width: 11.5%">3M</th>
                <th style="width: 11.5%">1Y</th>
              </tr>
            </thead>
            <tbody id="market-body">
              {% for r in market_rows %}
              <tr>
                <td>{{ r.name }}</td>
                <td>{{ r.as_of }}</td>
                <td style="font-weight:700;">{{ r.close|round(2) }}</td>
                <td style="{% if r.chg_1w_pct is not none %}{% if r.chg_1w_pct >= 0 %}color: var(--bull);{% else %}color: var(--bear);{% endif %}font-weight: 600;{% endif %}">{{ (r.chg_1w_pct|round(2) ~ "%") if r.chg_1w_pct is not none else "—" }}</td>
                <td style="{% if r.chg_1m_pct is not none %}{% if r.chg_1m_pct >= 0 %}color: var(--bull);{% else %}color: var(--bear);{% endif %}font-weight: 600;{% endif %}">{{ (r.chg_1m_pct|round(2) ~ "%") if r.chg_1m_pct is not none else "—" }}</td>
                <td style="{% if r.chg_3m_pct is not none %}{% if r.chg_3m_pct >= 0 %}color: var(--bull);{% else %}color: var(--bear);{% endif %}font-weight: 600;{% endif %}">{{ (r.chg_3m_pct|round(2) ~ "%") if r.chg_3m_pct is not none else "—" }}</td>
                <td style="{% if r.chg_1y_pct is not none %}{% if r.chg_1y_pct >= 0 %}color: var(--bull);{% else %}color: var(--bear);{% endif %}font-weight: 600;{% endif %}">{{ (r.chg_1y_pct|round(2) ~ "%") if r.chg_1y_pct is not none else "—" }}</td>
              </tr>
              {% endfor %}
              {% if (market_rows is none) or (market_rows|length == 0) %}
              <tr id="market-loading-row">
                <td colspan="7" class="meta">Loading…（这块会在页面打开后异步加载，不再阻塞整页）</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>


      <div class="card" style="margin-top: 14px;">
        <h2>History: Major Top/Bottom Comparisons After 2000 (Based on ^SPX Drawdown >= 15%)</h2>
        <table>
          <thead>
            <tr>
              <th style="width: 16%">Event</th>
              <th style="width: 12%; text-align: center;">Peak Date</th>
              <th style="width: 12%; text-align: center;">Trough Date</th>
              <th style="width: 8%; text-align: center;">Drawdown</th>
              <th style="width: 13%; text-align: center;">High Yield(P/T)</th>
              <th style="width: 13%; text-align: center;">Bull-Bear(P/T)</th>
              <th style="width: 13%; text-align: center;">Fear & Greed(P/T)</th>
              <th style="width: 13%; text-align: center;">S&P500 PE(P/T)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in bear_rows %}
            <tr>
              <td>{{ r.event_name }}</td>
              <td style="text-align: center;">{{ r.peak_date }}</td>
              <td style="text-align: center;">{{ r.trough_date }}</td>
              <td style="color: var(--bear); font-weight: bold; text-align: center;">{{ r.drawdown_pct }}%</td>
              <td style="text-align: center;">{{ (r.peak_hy ~ "%") if r.peak_hy else "—" }} / {{ (r.trough_hy ~ "%") if r.trough_hy else "—" }}</td>
              <td style="text-align: center;">{{ (r.peak_aaii ~ "%") if r.peak_aaii else "—" }} / {{ (r.trough_aaii ~ "%") if r.trough_aaii else "—" }}</td>
              <td style="text-align: center;">{{ r.peak_cnn if r.peak_cnn else "—" }} / {{ r.trough_cnn if r.trough_cnn else "—" }}</td>
              <td style="text-align: center;">{{ (r.peak_pe ~ "x") if r.peak_pe else "—" }} / {{ (r.trough_pe ~ "x") if r.trough_pe else "—" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="empty">Note: Historical comparison table is a hardcoded snapshot (for comparison and rule backtesting), data compiled from Federal Reserve FRED (HY Spread), AAII (Sentiment), CNN (Fear & Greed), Multpl (SP500 PE). CNN data not available before 2012.</div>
      </div>

      <div class="footer">
        {% if fetch_ok and fetch_ok|length > 0 %}
          <div style="margin-bottom:8px; color: rgba(46, 229, 157, 0.85);">
            Fetch Success: {{ fetch_ok | join("; ") }}
          </div>
        {% endif %}
        {% if fetch_err and fetch_err|length > 0 %}
          <div style="margin-bottom:8px; color: rgba(255, 93, 143, 0.9);">
            Fetch Failed: {{ fetch_err | join("; ") }}
          </div>
        {% endif %}

        Note: Run <code>trader ingest</code> or <code>trader fetch</code> to write data first, then refresh the page.
        API: <a href="/api/latest">/api/latest</a> / <a href="/api/alerts">/api/alerts</a>
        <div style="margin-top:6px;">
          Auto Fetch: <code>{{ "On" if auto_fetch_enabled else "Off" }}</code>
          <button onclick="toggleAutoFetch()" style="margin-left:10px; padding:2px 8px; font-size:11px;">
            {{ "Turn Off" if auto_fetch_enabled else "Turn On" }}
          </button>     Providers: <code>{{ auto_fetch_providers | join(",") }}</code>;
          Cooldown: <code>{{ cooldown_seconds }}s</code>
        </div>

        <script>
        function toggleAutoFetch() {
            fetch('/api/toggle-autofetch', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Refresh page to show new state
                    } else {
                        alert('Failed to toggle auto-fetch: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }
        </script>
        <script>
        function _fmtPct(v) {
          if (v === null || v === undefined) return "—";
          const n = Number(v);
          if (Number.isNaN(n)) return "—";
          return n.toFixed(2) + "%";
        }
        function _pctStyle(v) {
          if (v === null || v === undefined) return "";
          const n = Number(v);
          if (Number.isNaN(n)) return "";
          return (n >= 0 ? "color: var(--bull);" : "color: var(--bear);") + "font-weight: 600;";
        }
        function renderMarketRows(rows) {
          const tbody = document.getElementById("market-body");
          if (!tbody) return;
          const loading = document.getElementById("market-loading-row");
          if (loading) loading.remove();
          // 清空旧行（如果之前有服务器渲染/旧缓存）
          tbody.innerHTML = "";
          if (!rows || rows.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 7;
            td.className = "meta";
            td.textContent = "No data (stooq 可能网络不稳定；你可以稍后再试或刷新页面)";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }
          for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.name ?? "—"}</td>
              <td>${r.as_of ?? "—"}</td>
              <td style="font-weight:700;">${(r.close !== null && r.close !== undefined) ? Number(r.close).toFixed(2) : "—"}</td>
              <td style="${_pctStyle(r.chg_1w_pct)}">${_fmtPct(r.chg_1w_pct)}</td>
              <td style="${_pctStyle(r.chg_1m_pct)}">${_fmtPct(r.chg_1m_pct)}</td>
              <td style="${_pctStyle(r.chg_3m_pct)}">${_fmtPct(r.chg_3m_pct)}</td>
              <td style="${_pctStyle(r.chg_1y_pct)}">${_fmtPct(r.chg_1y_pct)}</td>
            `;
            tbody.appendChild(tr);
          }
        }
        async function loadMarketOverview() {
          try {
            const resp = await fetch("/api/market-overview");
            if (!resp.ok) return;
            const data = await resp.json();
            renderMarketRows(data.rows || []);
          } catch (e) {
            // ignore
          }
        }
        window.addEventListener("load", loadMarketOverview);
        </script>
        <div style="margin-top:6px;">
          Indicator Sources:
          {% for s in sources %}
            <a href="{{ s.url }}" target="_blank" rel="noopener">{{ s.name }}</a>{% if not loop.last %} / {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </body>
</html>

